# توثيق واجهة برمجة التطبيقات (API) لنظام المستخدمين والمصادقة

هذا المستند يوفر توثيقًا شاملاً لنقاط نهاية API المتعلقة بنظام المستخدمين والمصادقة في التطبيق. يتضمن معلومات حول كيفية استخدام كل نقطة نهاية، والمتطلبات، والاستجابات المتوقعة.

## جدول المحتويات

1. [التسجيل وتسجيل الدخول](#التسجيل-وتسجيل-الدخول)
   - [تسجيل مستخدم جديد](#تسجيل-مستخدم-جديد)
   - [تسجيل الدخول](#تسجيل-الدخول)
   - [تسجيل الخروج](#تسجيل-الخروج)
2. [إدارة الحساب](#إدارة-الحساب)
   - [عرض بيانات المستخدم الحالي](#عرض-بيانات-المستخدم-الحالي)
   - [تغيير كلمة المرور](#تغيير-كلمة-المرور)
3. [التحقق ورمز OTP](#التحقق-ورمز-otp)
   - [إرسال رمز OTP](#إرسال-رمز-otp)
   - [التحقق من رمز OTP](#التحقق-من-رمز-otp)
4. [استعادة كلمة المرور](#استعادة-كلمة-المرور)
   - [طلب استعادة كلمة المرور](#طلب-استعادة-كلمة-المرور)
   - [إعادة تعيين كلمة المرور](#إعادة-تعيين-كلمة-المرور)

## التسجيل وتسجيل الدخول

### تسجيل مستخدم جديد

ينشئ حساب مستخدم جديد في النظام.

- **URL**: `/api/register`
- **Method**: `POST`
- **المصادقة**: غير مطلوبة
- **معلمات الطلب**:
  - `name`: اسم المستخدم (مطلوب، نص، الحد الأقصى 255 حرف)
  - `email`: البريد الإلكتروني (مطلوب، بريد إلكتروني صالح، فريد)
  - `phone`: رقم الهاتف (مطلوب، رقم هاتف صالح، فريد)
  - `password`: كلمة المرور (مطلوب، الحد الأدنى 8 أحرف)
  - `password_confirmation`: تأكيد كلمة المرور (مطلوب، يجب أن يتطابق مع كلمة المرور)

#### استجابة ناجحة (201 Created)

```json
{
  "status": "success",
  "message": "تم إنشاء الحساب بنجاح",
  "data": {
    "user": {
      "id": 1,
      "name": "أحمد محمد",
      "email": "ahmed@example.com",
      "phone": "0501234567",
      "role": "user",
      "is_active": true,
      "created_at": "2023-05-15T10:30:00.000000Z",
      "updated_at": "2023-05-15T10:30:00.000000Z"
    },
    "token": "1|abcdefghijklmnopqrstuvwxyz123456"
  }
}
```

#### استجابة الخطأ (422 Unprocessable Entity)

```json
{
  "status": "error",
  "errors": {
    "email": [
      "البريد الإلكتروني مستخدم من قبل."
    ],
    "password": [
      "يجب أن تحتوي كلمة المرور على 8 أحرف على الأقل."
    ]
  }
}
```

### تسجيل الدخول

يسمح للمستخدم بتسجيل الدخول إلى النظام.

- **URL**: `/api/login`
- **Method**: `POST`
- **المصادقة**: غير مطلوبة
- **معلمات الطلب**:
  - `email`: البريد الإلكتروني (مطلوب، بريد إلكتروني صالح)
  - `password`: كلمة المرور (مطلوب)

#### استجابة ناجحة (200 OK)

```json
{
  "status": "success",
  "message": "تم تسجيل الدخول بنجاح",
  "data": {
    "user": {
      "id": 1,
      "name": "أحمد محمد",
      "email": "ahmed@example.com",
      "phone": "0501234567",
      "role": "user",
      "is_active": true,
      "created_at": "2023-05-15T10:30:00.000000Z",
      "updated_at": "2023-05-15T10:30:00.000000Z"
    },
    "token": "1|abcdefghijklmnopqrstuvwxyz123456"
  }
}
```

#### استجابة الخطأ (401 Unauthorized)

```json
{
  "status": "error",
  "message": "بيانات الاعتماد غير صحيحة"
}
```

### تسجيل الخروج

يقوم بتسجيل خروج المستخدم وإبطال الرمز المميز الحالي.

- **URL**: `/api/logout`
- **Method**: `POST`
- **المصادقة**: مطلوبة
- **معلمات الطلب**: لا يوجد

#### استجابة ناجحة (200 OK)

```json
{
  "status": "success",
  "message": "تم تسجيل الخروج بنجاح"
}
```

## إدارة الحساب

### عرض بيانات المستخدم الحالي

يعرض بيانات المستخدم المسجل دخوله حاليًا.

- **URL**: `/api/user`
- **Method**: `GET`
- **المصادقة**: مطلوبة
- **معلمات الطلب**: لا يوجد

#### استجابة ناجحة (200 OK)

```json
{
  "status": "success",
  "data": {
    "id": 1,
    "name": "أحمد محمد",
    "email": "ahmed@example.com",
    "phone": "0501234567",
    "role": "user",
    "is_active": true,
    "created_at": "2023-05-15T10:30:00.000000Z",
    "updated_at": "2023-05-15T10:30:00.000000Z"
  }
}
```

### تغيير كلمة المرور

يسمح للمستخدم بتغيير كلمة المرور الخاصة به.

- **URL**: `/api/change-password`
- **Method**: `POST`
- **المصادقة**: مطلوبة
- **معلمات الطلب**:
  - `current_password`: كلمة المرور الحالية (مطلوب)
  - `password`: كلمة المرور الجديدة (مطلوب، الحد الأدنى 8 أحرف)
  - `password_confirmation`: تأكيد كلمة المرور الجديدة (مطلوب، يجب أن يتطابق مع كلمة المرور الجديدة)

#### استجابة ناجحة (200 OK)

```json
{
  "status": "success",
  "message": "تم تغيير كلمة المرور بنجاح"
}
```

#### استجابة الخطأ (422 Unprocessable Entity)

```json
{
  "status": "error",
  "errors": {
    "current_password": [
      "كلمة المرور الحالية غير صحيحة."
    ]
  }
}
```

## التحقق ورمز OTP

### إرسال رمز OTP

يرسل رمز تحقق لمرة واحدة (OTP) إلى رقم هاتف المستخدم.

- **URL**: `/api/send-otp`
- **Method**: `POST`
- **المصادقة**: غير مطلوبة
- **معلمات الطلب**:
  - `phone`: رقم الهاتف (مطلوب، رقم هاتف صالح)

#### استجابة ناجحة (200 OK)

```json
{
  "status": "success",
  "message": "تم إرسال رمز التحقق بنجاح",
  "data": {
    "expires_at": "2023-05-15T11:00:00.000000Z"
  }
}
```

#### استجابة الخطأ (422 Unprocessable Entity)

```json
{
  "status": "error",
  "errors": {
    "phone": [
      "رقم الهاتف غير صالح."
    ]
  }
}
```

### التحقق من رمز OTP

يتحقق من صحة رمز OTP المدخل.

- **URL**: `/api/verify-otp`
- **Method**: `POST`
- **المصادقة**: غير مطلوبة
- **معلمات الطلب**:
  - `phone`: رقم الهاتف (مطلوب، رقم هاتف صالح)
  - `otp`: رمز التحقق (مطلوب، 6 أرقام)

#### استجابة ناجحة (200 OK)

```json
{
  "status": "success",
  "message": "تم التحقق من الرمز بنجاح",
  "data": {
    "verified": true
  }
}
```

#### استجابة الخطأ (422 Unprocessable Entity)

```json
{
  "status": "error",
  "message": "رمز التحقق غير صحيح أو منتهي الصلاحية"
}
```

## استعادة كلمة المرور

### طلب استعادة كلمة المرور

يرسل رابط إعادة تعيين كلمة المرور إلى البريد الإلكتروني للمستخدم.

- **URL**: `/api/forgot-password`
- **Method**: `POST`
- **المصادقة**: غير مطلوبة
- **معلمات الطلب**:
  - `email`: البريد الإلكتروني (مطلوب، بريد إلكتروني صالح)

#### استجابة ناجحة (200 OK)

```json
{
  "status": "success",
  "message": "تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني"
}
```

#### استجابة الخطأ (422 Unprocessable Entity)

```json
{
  "status": "error",
  "errors": {
    "email": [
      "لا يمكن العثور على مستخدم بهذا البريد الإلكتروني."
    ]
  }
}
```

### إعادة تعيين كلمة المرور

يعيد تعيين كلمة مرور المستخدم باستخدام الرمز المرسل.

- **URL**: `/api/reset-password`
- **Method**: `POST`
- **المصادقة**: غير مطلوبة
- **معلمات الطلب**:
  - `email`: البريد الإلكتروني (مطلوب، بريد إلكتروني صالح)
  - `token`: رمز إعادة التعيين (مطلوب)
  - `password`: كلمة المرور الجديدة (مطلوب، الحد الأدنى 8 أحرف)
  - `password_confirmation`: تأكيد كلمة المرور الجديدة (مطلوب، يجب أن يتطابق مع كلمة المرور الجديدة)

#### استجابة ناجحة (200 OK)

```json
{
  "status": "success",
  "message": "تم إعادة تعيين كلمة المرور بنجاح"
}
```

#### استجابة الخطأ (422 Unprocessable Entity)

```json
{
  "status": "error",
  "errors": {
    "token": [
      "رمز إعادة التعيين غير صالح أو منتهي الصلاحية."
    ]
  }
}
```

## أدوار المستخدمين

- **user**: مستخدم عادي، يمكنه تصفح العقارات وإضافتها للمفضلة وتقديم طلبات شراء والمشاركة في المزادات
- **admin**: مشرف، لديه صلاحيات إضافية لإدارة المستخدمين والعقارات والمزادات وطلبات الشراء

## ملاحظات هامة

1. جميع نقاط النهاية التي تتطلب مصادقة تستخدم Laravel Sanctum وتتطلب إرسال رمز المصادقة في ترويسة الطلب.
2. يتم التحقق من رقم الهاتف عند التسجيل باستخدام نظام OTP.
3. يمكن للمستخدمين استعادة كلمات المرور الخاصة بهم عبر البريد الإلكتروني.
4. يتم تعطيل حسابات المستخدمين غير النشطة تلقائيًا ويمكن للمشرفين إعادة تنشيطها.
5. يتم تشفير كلمات المرور باستخدام خوارزمية تجزئة آمنة ولا يمكن استردادها بعد التشفير.